(function(){"use strict";function n(){}angular.module("masterkey.api",["ngSanitize","ui.select","pascalprecht.translate"]).config(["configurations",n])})(),function(n){n.module("masterkey.api").constant("configurations",{endpoint:{authTenant:"dev",authToken:"",host:"dev.masterkeyeducation.com:8080",protocol:"http",urlbase:"masterkey/",server:"agency/"},location:{urlbase:"bower_components/",home:"masterkey-api/",data:"data/",templates:"templates/"}})}(angular),function(n){"use strict";function t(t){function i(n){var i="course/"+n;return t.getFutureSingleObject(i)}function r(n,i){var r="agency/course/"+n+"/courseVariant/"+i;return t.getFutureSingleObject(r)}function u(n,i){var r="agency/place/"+i.toLowerCase()+"/"+n;return t.getFutureSingleObject(r)}function f(n){var i="agency/courseVariant/"+n+"/courseEvent";return t.getFuturePagedObject(i)}function e(i,r,u){var e="agency/course/"+r,f=n.extend({max:750},u);return f[i.type]=i.id,t.getFuturePagedObject(e,f)}function o(){return t.getFuturePagedObject("agency/course/1/agencyPromotion")}function s(n,i){var r="agency/place/"+i,u={q:n};return t.getFuturePagedObject(r,u)}function h(n){!n}return{getCourse:i,getCourseVariant:r,getPlace:u,listByCourseVariant:f,listByPlaceAndCourseType:e,listOptionalPromotion:o,queryByCourseType:s,setQuoteDataScope:h}}n.module("masterkey.api").factory("courseService",["futureObjectService",t])}(angular),function(n){"use strict";n.module("masterkey.api").factory("CourseType",function(t){function i(t){n.extend(this,t,u)}var r="courseType",u={language:!0,category:!0,area:!0};return i.get=function(n){return i.query().then(function(t){return _.find(t,{value:n})})},i.query=function(){return t.loadSource(r).then(function(n){return n.map(function(n){return new i(n)})})},i})}(angular),function(n){"use strict";n.module("masterkey.api").service("dataFile",["$http","configurations",function(n,t){function c(n,t){return f(n).then(function(n){return t,n[t]})}function f(t){return n.get(u+t+e,{cache:!0}).then(function(n){return n.data})}function l(n){t.endpoint.authToken=n}var e=".json",i=t.location,r=t.endpoint,o=r.protocol+"://"+r.host+"/",u=i.urlbase+i.home+i.data,s=i.urlbase+i.home+i.templates,h=o+"cdn/";return{dataPath:u,get:c,imagesPath:h,loadSource:f,setAuthToken:l,templatesPath:s}}])}(angular),function(n){"use strict";n.module("masterkey.api").factory("DraftCommand",function(){function n(n,t,i){this.course=n;this.courseLine={product:t,event:i};this.associatedServiceLine={};this.agencyPromotionList=[]}return n.prototype.addAssociatedService=function(n){var t=Object.keys(n);this.associatedServiceLine=_.reduce(t,function(t,i){return t[i]=t[i]||n[i],t},this.associatedServiceLine)},n})}(angular),function(n){"use strict";function t(n,t){function f(t,i){var f=u(),e=r+t,o={params:i,headers:f};return n.get(e,o).then(function(n){return n.data})}function u(){return{"X-Auth-Token":i.authToken,"X-Auth-Tenant":i.authTenant}}var i=t.endpoint,r=i.protocol+"://"+i.host+"/"+i.urlbase;return{apiPath:r,get:f,headers:u}}n.module("masterkey.api").factory("endpointService",["$http","configurations",t])}(angular),function(n){"use strict";n.module("masterkey.api").filter("eventFormat",function(n){return function(t){var i=n("date")(t.start,"fullDate"),r=t.duration?n("translate")("event.duration."+t.duration.term,t.duration):"";return i+" ["+r+"]"}})}(angular),function(n){"use strict";function t(t,i,r){function e(n,t,i){return u(n,t,i).$promise}function f(t,r){function f(n){return n==="single"?s:n==="list"?l:c}function e(n){return u.$resolved=!0,u.$error=n?n.statusText||"Error!":"Error!",n}function s(t){return n.extend(u,t),u.$resolved=!0,u}function c(n){return n.resourceList.forEach(function(n){u.push(n)}),n.meta&&(u.$meta=new i(n)),u.$resolved=!0,u}function l(n){return n.forEach(function(n){u.push(n)}),u.$resolved=!0,u}var o=f(r),u=h(r);return u.$resolved=!1,u.$promise=t.then(o,e),u}function u(n,t,i){return f(r.get(n,t),i)}function o(n,t){return u(n,t,"listPaged")}function s(n,t){return u(n,t,"single")}function h(n){return n!=="single"?[]:{}}return{getDataPromise:f,getFutureObject:u,getFuturePagedObject:o,getFutureSingleObject:s,getPromise:e}}n.module("masterkey.api").factory("futureObjectService",["$http","BackendPagination","endpointService",t])}(angular),function(n){function t(n){function i(){}var t=n.templatesPath+"mk-quote-associated.html";return{link:i,templateUrl:t,replace:!0,scope:{options:"=",serviceLine:"="}}}n.module("masterkey.api").directive("mkQuoteAssociated",["dataFile",t])}(angular),function(n){function t(n,t){function r(i){function r(n,r){return t.updateOptions(i,n,r)}n.setAuthToken(i.userToken);t.setQuoteDataScope(i,i.courseId,i.courseVariantId);i.activeTab="course";i.isActiveTab=function(n){return n===i.activeTab};i.refreshQuote=function(){};i.refreshDraft=function(n,u){i.cmd=t.refreshCommand(n,i.options);i.options=r(i.cmd,i.options);i.courseLine.qty=u};i.setTab=function(n){i.activeTab=n}}var i=n.templatesPath+"mk-quote-template.html";return{link:r,templateUrl:i,scope:{courseId:"=mkCourse",courseVariantId:"=mkCourseVariant",userToken:"=mkUser"}}}n.module("masterkey.api").directive("mkQuote",["dataFile","quoteService",t])}(angular),function(n){"use strict";function t(n){function i(){}var t=n.templatesPath+"mk-quote-variant.html";return{link:i,templateUrl:t,replace:!0,scope:{fee:"="}}}n.module("masterkey.api").directive("mkQuoteVariant",["dataFile",t])}(angular),function(n){function t(n,t){function r(i){function o(){i.courseList=_.map(i.unfilteredList,function(n){return n});e(i.courseList)}function r(n,t){return u(n,t)&&n.institute.city.id==t.city.id}function u(n,t){return n.institute&&n.institute.city&&n.institute.city.country&&n.institute.city.country.id==t.city.country.id}function f(n,t){return n.institute&&n.institute.school&&n.institute.school.id==t.school.id}function e(n){var r,u,t,f,e;for(i.options={cityList:[],schoolList:[]},r=0;r<n.length;r++)u=n[r],u.institute&&(t=u.institute.city,f=u.institute.school,t&&(e=_.some(i.options.cityList,function(n){return n.id&&n.id==t.id&&n.country&&n.country.id==t.country.id}),e||i.options.cityList.push(t)),f&&(e=_.some(i.options.schoolList,function(n){return n.id&&n.id==f.id}),e||i.options.schoolList.push(f)))}t.setAuthToken(i.userToken);i.query={};i.filterCourses=function(){var n={};_.forIn(i.query,function(t,i){t&&(n[i]=t)});i.courseList=_.filter(i.unfilteredList,function(t){return n.school?n.city?f(t,n)&&r(t,n):f(t,n):n.city?n.country?r(t,n)&&u(t,n):r(t,n):n.country?u(t,n):!0})};i.getIconType=function(n){switch(n){case"city":return"fa fa-map-marker";case"country":return"fa fa-flag";case"school":return"fa fa-university"}return"fa fa-question"};i.goSearch=function(t,r){i.unfilteredList=n.listByPlaceAndCourseType(t,r);i.unfilteredList.$promise.then(o)};i.refreshOptionslist=e}var i=t.templatesPath+"mk-search-template.html";return{restrict:"EA",link:r,templateUrl:i,scope:{userToken:"=mkUser"}}}n.module("masterkey.api").directive("mkSearch",["courseService","dataFile",t])}(angular),function(n){"use strict";function t(n){var t=n.templatesPath+"mk-search-filters.html";return{restrict:"EA",templateUrl:t,scope:{courseList:"=",options:"=lists",place:"=",query:"=filters",refresh:"&"}}}n.module("masterkey.api").directive("mkSearchFilters",["dataFile",t])}(angular),function(n){"use strict";function t(n){function i(t){t.imageUrl=function(t){return n.imagesPath+t}}var t=n.templatesPath+"mk-search-list.html";return{link:i,templateUrl:t}}n.module("masterkey.api").directive("mkSearchList",["dataFile",t])}(angular),function(n){function t(n,t,i){function u(i){n.query().then(function(n){i.courseTypeList=n});i.placeList=[];i.refreshPlaceList=function(n,r){if(n.length<1){i.placeList=[];return}i.placeList=t.queryByCourseType(n,r)}}var r=i.templatesPath+"mk-search-topbar.html";return{link:u,templateUrl:r}}n.module("masterkey.api").directive("mkSearchTopbar",["CourseType","courseService","dataFile",t])}(angular),function(n){"use strict";n.module("masterkey.api").factory("BackendPagination",function(){function n(n){this.size=n.meta.max;this.total=n.meta.totalCount;this.offset=n.meta.offset;this.count=n.resourceList.length;this.page=Math.ceil(this.offset/this.size)+1;this.pages=Math.ceil(this.total/this.size)}return n.prototype.getMeta=function(){return{totalCount:this.total,max:this.size,offset:this.getOffset()}},n.prototype.getOffset=function(){return this.size*(this.page-1)},n})}(angular),function(n){function t(t,i){function u(n,i,u){function c(){n.cmd.course=f;n.opportunity.courseType=f.type;n.opportunity.isClientStudent=!0;s(n.cmd)}function l(){n.cmd.courseLine.product=e;s(n.cmd)}function a(){n.cmd.courseLine.event=o[0];s(n.cmd)}function s(t){f.$resolved&&e.$resolved&&o.$resolved&&(n.options=r(n,t))}if(n){var f=t.getCourse(i),e=t.getCourseVariant(i,u),o=t.listByCourseVariant(u),h=t.listOptionalPromotion(i);f.$promise.then(c);e.$promise.then(l);o.$promise.then(a);n.course=f;n.courseVariant=e;n.courseEventList=o;n.optionalPromotionList=h;n.draft={};n.options=[];n.localCurrency=null;n.saveMode="existing";n.opportunity={};n.quote={};n.cmd={courseLine:{event:{}},associatedServiceLine:{},agencyPromotionList:h};n.courseLine=n.cmd.courseLine}}function f(n,t,i,r){var u=[];return i&&i.duration&&t&&t.currentBasePrice&&(u=[_.range(i.duration.min,i.duration.max+1),_.range(t.duration.min,t.duration.max+1),t.currentBasePrice.supportedQty]),{product:_.filter(n.variant,function(n){return n.id!==t.id}),event:r,qty:_.intersection(u[0],u[1],u[2])}}function e(t,r){return n.extend(new i,t,{courseLine:o(t.courseLine,r),accommodationLine:s(t)})}function o(n,t){return n.qty=n.qty||t.courseLine.qty[0],n}function s(t){var i=t.accommodationLine;if(i&&i.product)return n.extend({},i,{qty:i.qty||t.courseLine.qty,startDate:i.startDate||t.courseLine.event.start})}function r(n,t,i){function r(n){var t={product:null};return i?i[n].product?i[n]:t:t}return{courseLine:f(n.course,n.courseVariant,t.courseLine.event,n.courseEventList),accommodationLine:r("accommodationLine"),associatedServiceLine:r("associatedServiceLine"),providerServiceLine:r("providerServiceLine")}}return{setQuoteDataScope:u,refreshCommand:e,updateOptions:r}}n.module("masterkey.api").factory("quoteService",["courseService","DraftCommand",t])}(angular);