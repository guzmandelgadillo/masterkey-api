(function(){"use strict";angular.module("masterkey.api",["ngSanitize","ui.select","pascalprecht.translate"])})(),function(n){n.module("masterkey.api").constant("configurations",{endpoint:{authTenant:"dev",authToken:"null",host:"dev.masterkeyeducation.com:8080",protocol:"http",urlbase:"masterkey/",server:"agency/"},location:{urlbase:"/Scripts/",home:"masterkey/",data:"data/",templates:"templates/"}})}(angular),function(n){"use strict";function t(t){function i(n){var i="course/"+n;return t.getFutureSingleObject(i)}function r(n,i){var r="agency/course/"+n+"/courseVariant/"+i;return t.getFutureSingleObject(r)}function u(n,i){var r="agency/place/"+i.toLowerCase()+"/"+n;return t.getFutureSingleObject(r)}function f(n){var i="agency/courseVariant/"+n+"/courseEvent";return t.getFuturePagedObject(i)}function e(i,r,u){var e="agency/course/"+r,f=n.extend({max:750},u);return f[i.type]=i.id,t.getFuturePagedObject(e,f)}function o(){return t.getFuturePagedObject("agency/course/1/agencyPromotion")}function s(n,i){var r="agency/place/"+i,u={q:n};return t.getFuturePagedObject(r,u)}function h(n){!n}return{getCourse:i,getCourseVariant:r,getPlace:u,listByCourseVariant:f,listByPlaceAndCourseType:e,listOptionalPromotion:o,queryByCourseType:s,setQuoteDataScope:h}}n.module("masterkey.api").factory("courseService",["futureObjectService",t])}(angular),function(n){"use strict";n.module("masterkey.api").factory("CourseType",function(t){function i(t){n.extend(this,t,u)}var r="courseType",u={language:!0,category:!0,area:!0};return i.get=function(n){return i.query().then(function(t){return _.find(t,{value:n})})},i.query=function(){return t.loadSource(r).then(function(n){return n.map(function(n){return new i(n)})})},i})}(angular),function(n){"use strict";n.module("masterkey.api").service("dataFile",["$http","configurations",function(n,t){function c(n,t){return f(n).then(function(n){return t,n[t]})}function f(t){return n.get(u+t+e,{cache:!0}).then(function(n){return n.data})}function l(n){t.endpoint.authToken=n}var e=".json",i=t.location,r=t.endpoint,o=r.protocol+"://"+r.host+"/",u=i.urlbase+i.home+i.data,s=i.urlbase+i.home+i.templates,h=o+"cdn/";return{dataPath:u,get:c,imagesPath:h,loadSource:f,setAuthToken:l,templatesPath:s}}])}(angular),function(n){"use strict";n.module("masterkey.api").factory("DraftCommand",function(){function n(n,t,i){this.course=n;this.courseLine={product:t,event:i};this.associatedServiceLine={};this.agencyPromotionList=[]}return n.prototype.addAssociatedService=function(n){var t=Object.keys(n);this.associatedServiceLine=_.reduce(t,function(t,i){return t[i]=t[i]||n[i],t},this.associatedServiceLine)},n})}(angular),function(n){"use strict";function t(n,t){function f(t,i){var f=u(),e=r+t,o={params:i,headers:f};return n.get(e,o).then(function(n){return n.data})}function u(){return{"X-Auth-Token":i.authToken,"X-Auth-Tenant":i.authTenant}}var i=t.endpoint,r=i.protocol+"://"+i.host+"/"+i.urlbase;return{apiPath:r,get:f,headers:u}}n.module("masterkey.api").factory("endpointService",["$http","configurations",t])}(angular),function(n){"use strict";n.module("masterkey.api").filter("eventFormat",function(n){return function(t){var i=n("date")(t.start,"fullDate"),r=t.duration?n("translate")("event.duration."+t.duration.term,t.duration):"";return i+" ["+r+"]"}})}(angular),function(n){"use strict";function t(t,i,r,u){function o(n,t,i){return f(n,t,i).$promise}function e(t,r){function f(n){return n==="single"?s:n==="list"?l:h}function e(n){return u.$resolved=!0,u.$error=n?n.statusText||"Error!":"Error!",n}function s(t){return n.extend(u,t),u.$resolved=!0,u}function h(n){return n.resourceList.forEach(function(n){u.push(n)}),n.meta&&(u.$meta=new i(n)),u.$resolved=!0,u}function l(n){return n.forEach(function(n){u.push(n)}),u.$resolved=!0,u}var o=f(r),u=c(r);return u.$resolved=!1,u.$promise=t.then(o,e),u}function f(n,t,i){return e(u.get(n,t),i)}function s(n,t){return f(n,t,"listPaged")}function h(n,t){return f(n,t,"single")}function c(n){return n!=="single"?[]:{}}return{getDataPromise:e,getFutureObject:f,getFuturePagedObject:s,getFutureSingleObject:h,getPromise:o}}n.module("masterkey.api").factory("futureObjectService",["$http","BackendPagination","configurations","endpointService",t])}(angular),function(n){function t(n){function i(){}var t=n.templatesPath+"mk-quote-associated.html";return{link:i,templateUrl:t,replace:!0,scope:{options:"=",serviceLine:"="}}}n.module("masterkey.api").directive("mkQuoteAssociated",["dataFile",t])}(angular),function(n){function t(n,t){function r(i){function r(n,r){return t.updateOptions(i,n,r)}n.setAuthToken(i.userToken);t.setQuoteDataScope(i,i.courseId,i.courseVariantId);i.activeTab="course";i.isActiveTab=function(n){return n===i.activeTab};i.options=r(i.cmd);i.refreshQuote=function(){};i.refreshDraft=function(n){i.cmd=t.refreshCommand(n);i.options=r(i.cmd,i.options)};i.setTab=function(n){i.activeTab=n}}var i=n.templatesPath+"mk-quote-template.html";return{link:r,templateUrl:i,scope:{courseId:"=mkCourse",courseVariantId:"=mkCourseVariant",userToken:"=mkUser"}}}n.module("masterkey.api").directive("mkQuote",["dataFile","quoteService",t])}(angular),function(n){"use strict";function t(n){function i(){}var t=n.templatesPath+"mk-quote-variant.html";return{link:i,templateUrl:t,replace:!0,scope:{fee:"="}}}n.module("masterkey.api").directive("mkQuoteVariant",["dataFile",t])}(angular),function(n){function t(n,t){function r(i){function u(){i.courseList=_.map(i.unfilteredList,function(n){return n});r(i.courseList)}function r(n){i.options={};_.forIn({cityList:"institute.city",countryList:"institute.city.country",schoolList:"institute.school",categoryList:"category"},function(t,r){var u=_.uniqBy(n,t);i.options[r]=_.map(u,function(n){return n[t]});i.options[r]=_.compact(i.options[r])})}t.setAuthToken(i.userToken);i.filterCourses=function(){_.forIn(query,function(n,t){n&&(query[t]=n)});i.courseList=_.filter(i.unfilteredList,query)};i.getIconType=function(n){switch(n){case"city":return"fa fa-map-marker";case"country":return"fa fa-flag";case"school":return"fa fa-university"}return"fa fa-question"};i.goSearch=function(t,r){i.unfilteredList=n.listByPlaceAndCourseType(t,r);i.unfilteredList.$promise.then(u)};i.refreshOptionslist=r}var i=t.templatesPath+"mk-search-template.html";return{restrict:"EA",link:r,templateUrl:i,scope:{userToken:"=mkUser"}}}n.module("masterkey.api").directive("mkSearch",["courseService","dataFile",t])}(angular),function(n){"use strict";function t(n){var t=n.templatesPath+"mk-search-filters.html";return{restrict:"EA",templateUrl:t,scope:{courseList:"=",options:"=lists",query:"=filters",refresh:"&"}}}n.module("masterkey.api").directive("mkSearchFilters",["dataFile",t])}(angular),function(n){"use strict";function t(n){function i(t){t.imageUrl=function(t){return n.imagesPath+t}}var t=n.templatesPath+"mk-search-list.html";return{link:i,templateUrl:t}}n.module("masterkey.api").directive("mkSearchList",["dataFile",t])}(angular),function(n){function t(n,t,i){function u(i){n.query().then(function(n){i.courseTypeList=n});i.placeList=[];i.refreshPlaceList=function(n,r){if(n.length<1){i.placeList=[];return}i.placeList=t.queryByCourseType(n,r)}}var r=i.templatesPath+"mk-search-topbar.html";return{link:u,templateUrl:r}}n.module("masterkey.api").directive("mkSearchTopbar",["CourseType","courseService","dataFile",t])}(angular),function(n){"use strict";n.module("masterkey.api").factory("BackendPagination",function(){function n(n){this.size=n.meta.max;this.total=n.meta.totalCount;this.offset=n.meta.offset;this.count=n.resourceList.length;this.page=Math.ceil(this.offset/this.size)+1;this.pages=Math.ceil(this.total/this.size)}return n.prototype.getMeta=function(){return{totalCount:this.total,max:this.size,offset:this.getOffset()}},n.prototype.getOffset=function(){return this.size*(this.page-1)},n})}(angular),function(n){function t(t,i){function r(n,i,r){if(n){var u=t.getCourse(i),e=t.getCourseVariant(i,r),o=t.listByCourseVariant(r),f=t.listOptionalPromotion(i);n.course=u;n.courseVariant=e;n.optionalPromotionList=f;n.draft={};n.options=[];n.localCurrency=null;n.saveMode="existing";n.opportunity={};n.quote={};n.cmd={courseLine:{event:{}},associatedServiceLine:{},agencyPromotionList:f}}}function u(n,t,i,r){var u=[];return i&&i.duration&&t&&t.currentBasePrice&&(u=[_.range(i.duration.min,i.duration.max+1),_.range(t.duration.min,t.duration.max+1),t.currentBasePrice.supportedQty]),{product:_.filter(n.variant,function(n){return n.id!==t.id}),event:r,qty:_.intersection(u[0],u[1],u[2])}}function f(t,r){return n.extend(new i,t,{courseLine:e(t.courseLine,r),accommodationLine:o(t)})}function e(n,t){return n.qty=n.qty||t.courseLine.qty[0],n}function o(t){var i=t.accommodationLine;if(i&&i.product)return n.extend({},i,{qty:i.qty||t.courseLine.qty,startDate:i.startDate||t.courseLine.event.start})}function s(n,t,i){function r(n){var t={product:null};return i?i[n].product?i[n]:t:t}return{courseLine:u(n.course,n.courseVariant,t.courseLine.event,n.courseEventList),accommodationLine:r("accommodationLine"),associatedServiceLine:r("associatedServiceLine"),providerServiceLine:r("providerServiceLine")}}return{setQuoteDataScope:r,refreshCommand:f,updateOptions:s}}n.module("masterkey.api").factory("quoteService",["courseService","DraftCommand",t])}(angular);